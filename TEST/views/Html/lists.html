<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Lists</title>
    <link rel="stylesheet" href="/CuPO/WEB/TEST/views/Style-CSS/styles-lists.css">
</head>

<body>
    <header class="header" id="header">
        <div class="nav-container">
            <a class="btn-home active" href="/home/homeL">Home</a>
            <a class="btn-logout" href="/CuPO/WEB/TEST/controllers/logout.php">Logout</a>
        </div>
    </header>
    <main class="container mt-5">
        <div class="filter-section">
            <h2>My Lists</h2>
            <button id="createListBtn">Create New List</button>
            <button id="createGroupBtn">Create New Group</button>
        </div>

        <div class="grid" id="listsGrid">
            <!-- Items will be populated here by JavaScript -->
        </div>
    </main>

    <!-- Create List Modal -->
    <div id="createListModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Create New List</h2>
            <form id="createListForm">
                <div class="form-group">
                    <label for="listName">List Name:</label>
                    <input type="text" id="listName" name="listName" required>
                </div>
                <button type="submit">Create</button>
            </form>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGroupModal()">&times;</span>
            <h2>Create New Group</h2>
            <form id="createGroupForm">
                <div class="form-group">
                    <label for="groupName">Group Name:</label>
                    <input type="text" id="groupName" name="groupName" required>
                </div>
                <button type="submit">Create</button>
            </form>
        </div>
    </div>

    <!-- Add Email Modal -->
    <div id="addEmailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmailModal()">&times;</span>
            <h2>Add Email to Group</h2>
            <form id="addEmailForm">
                <input type="hidden" id="listIdInput" name="listId">
                <div class="form-group">
                    <label for="emailInput">Email:</label>
                    <input type="email" id="emailInput" name="email" required>
                </div>
                <button type="submit">Add</button>
            </form>
        </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('createListBtn').addEventListener('click', function () {
        document.getElementById('createListModal').style.display = 'block';
    });

    document.getElementById('createGroupBtn').addEventListener('click', function () {
        document.getElementById('createGroupModal').style.display = 'block';
    });

    document.addEventListener('DOMContentLoaded', function () {
    let createGroupForm = document.getElementById('createGroupForm');
    
    // Verificăm dacă evenimentul este deja atașat
    if (createGroupForm.dataset.initialized !== "true") {
        createGroupForm.addEventListener('submit', function (event) {
            event.preventDefault();
            const groupName = document.getElementById('groupName').value;

            const data = { name: groupName, group: 'yes' };
            console.log('Data to be sent:', data);

            fetch('/CuPO/WEB/TEST/api/lists', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text) });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Group created successfully');
                    loadLists();
                    closeGroupModal();
                } else {
                    alert('Error creating group');
                }
            })
            .catch(error => {
                console.error('Error creating group:', error);
                alert('Error creating group: ' + error.message);
            });
        });

        // Marcam formularul ca initializat
        createGroupForm.dataset.initialized = "true";
    }
});



    document.getElementById('createGroupForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const groupName = document.getElementById('groupName').value;

        fetch('/CuPO/WEB/TEST/api/lists', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: groupName, group: 'yes' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Group created successfully');
                document.cookie = `currentListId=${data.listId}; path=/`; // Save group ID in cookie
                loadLists();
                closeGroupModal();
            } else {
                alert('Error creating group');
            }
        })
        .catch(error => {
            console.error('Error creating group:', error);
            alert('Error creating group: ' + error.message);
        });
    });

    function getCookie(name) {
    let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    if (match) {
        return match[2];
    } else {
        return null;
    }
}

   document.getElementById('addEmailForm').addEventListener('submit', function (event) {
    event.preventDefault();
    const email = document.getElementById('emailInput').value;
    const listId = getCookie('currentListId'); // Preia ID-ul din cookie

    // Debugging: afișăm valorile care sunt trimise
    console.log('Sending data:', { listId: listId, email: email });

    fetch('/CuPO/WEB/TEST/api/lists', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ listId: listId, email: email })
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => { throw new Error(text) });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('Email added successfully');
        } else {
            alert('Error adding email');
        }
    })
    .catch(error => {
        console.error('Error adding email:', error);
        alert('Error adding email: ' + error.message);
    });
});


    function closeModal() {
        document.getElementById('createListModal').style.display = 'none';
    }

    function closeGroupModal() {
        document.getElementById('createGroupModal').style.display = 'none';
    }

    function closeEmailModal() {
        document.getElementById('addEmailModal').style.display = 'none';
    }

    function loadLists() {
        fetch('/CuPO/WEB/TEST/api/lists')
            .then(response => response.json())
            .then(data => {
                const listsGrid = document.getElementById('listsGrid');
                listsGrid.innerHTML = ''; // Clear the grid

                data.forEach(list => {
                    const gridItem = document.createElement('div');
                    gridItem.classList.add('grid-item');

                    gridItem.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><a href="#">${list.name}</a></h5>
                                <button onclick="seeList(${list.id})">See List</button>
                                <button onclick="shop(${list.id})">Shop</button>
                                ${list.group === 'yes' ? `<button onclick="openAddEmailModal(${list.id})">Add Person</button>` : ''}
                            </div>
                        </div>
                    `;

                    listsGrid.appendChild(gridItem);
                });
            })
            .catch(error => {
                console.error('Error fetching lists:', error);
                alert('Error fetching lists: ' + error.message);
            });
    }

    function seeList(listId) {
        // Implement the logic to see the list
    }

    function shop(listId) {
        document.cookie = `currentListId=${listId}; path=/`;
        window.location.href = "Shop.php"; // Make sure this is the correct path to your Shop.php
    }

    function openAddEmailModal(listId) {
        document.getElementById('addEmailModal').style.display = 'block';
        document.getElementById('listIdInput').value = listId;
    }

    // Load lists on page load
    loadLists();
});

    </script>
</body>

</html>